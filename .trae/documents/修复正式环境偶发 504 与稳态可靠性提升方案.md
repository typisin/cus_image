## 现象与定位
- 浏览器控制台出现 `POST https://www.cusimage.com/api/coze/describer/run 504 (Gateway Timeout)`，伴随 "workflow failed body len" 日志。
- 服务器端 `api/coze/describer/run.js` 使用 `runtime: 'edge'`，直接 `fetch` 到 `https://api.coze.cn/v1/workflow/run`，缺少超时控制与重试。
- 客户端 `describeViaWorkflowByFileId()` 调用该接口，没有重试与降级兜底，生成期间仅简单 loading。

## 改造目标
- 避免用户请求直接命中 504；提升端到端成功率与用户体验。
- 为生产环境增加超时控制、重试机制、可观测性、以及客户端兜底策略。

## 服务端（Edge Function）改造
1. 请求超时与重试
- 使用 `AbortController` 为 `fetch` 增加超时（如 15s），失败时进行指数退避重试（如 3 次：0.5s、1.5s、3s）。
- 捕捉 `res.status>=500 或网络异常` 时重试；`4xx` 直接返回。
2. 明确错误消息与结构化日志
- 将 504/500 映射为 `{ error: 'upstream_timeout', retryable: true }`，同时附带 `execute_id/log_id`。
- 记录 `console.time` 请求耗时、token/参数存在性、payload 的关键字段长度。
3. 降级返回
- 超时后返回统一错误体，提示客户端可以进行本地 `analyze()` 降级。
4. 可选：运行时与时长
- 若 504 与 Vercel 边缘时长限制相关，考虑改为 `runtime: 'nodejs'`（Serverless Functions）并在 `vercel.json` 设置 `functions.maxDuration`（如 30–60s）。
- 如果继续用 Edge，需确认计划的最大执行时间并在代码内显式超时与重试。

## 客户端改造
1. 带超时与重试的请求封装
- 在 `describeViaWorkflowByFileId()` 增加超时（如 15s）与指数退避重试（如最多 2–3 次），期间展示进度。
2. 体验优化
- 右侧 `textarea` 面板内显示 loading 覆盖层；失败时显示可重试提示与“本地快速分析”按钮。
3. 降级兜底
- 若服务端返回 `retryable: true` 或最终失败，自动调用本地 `analyze(originalImagePreview)` 生成简版描述并写入 `textarea`；同时保留“重试服务端”按钮。

## 可观测性与排查
- 在 Edge Function 追加 `execute_id/log_id` 输出到响应，客户端写入 console；为偶发错误提供追踪线索。
- 在客户端写入失败次数与最终降级路径日志。

## 变更范围
- 修改 `api/coze/describer/run.js`（仅逻辑，不改变入参与响应结构的兼容性）。
- 更新前端 `image-describer.html` 中的 `describeViaWorkflowByFileId()` 与 UI loading/错误提示逻辑。
- 如需扩大执行时长，增改 `vercel.json` 的 `functions.maxDuration` 或切换 `runtime`。

## 验证
- 本地 `vercel dev` 下模拟：人为将 Edge 请求指向延迟/失败以验证重试与降级。
- 正式环境观察 504 路由与错误率是否下降；确认用户体验稳定。

如果确认方案，我将直接落地代码改造（服务端超时重试+客户端重试与降级）并在本地 Vercel 环境完成验证。